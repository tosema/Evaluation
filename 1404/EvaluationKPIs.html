<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ارزیابی</title>
  <style>
    body { font-family: Vazirmatn, sans-serif; margin: 20px; background: #f9f9f9; }
    .card { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); margin-bottom: 20px; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .avatar { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; }
    .name { font-size: 1.3em; font-weight: bold; }
    .role { color: gray; font-size: 0.9em; }
    .axis { font-size: 1.1em; font-weight: bold; margin-top: 15px; }
    .kpi { margin: 8px 0; font-size: 0.95em; }
    .stars span { font-size: 22px; cursor: pointer; color: #ccc; }
    .stars span.active { color: gold; }
    button { margin-top: 20px; padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="userCard" class="card" style="display:none;"></div>
  <div id="evaluateList" class="card" style="display:none;"></div>
  <button id="submitBtn" style="display:none;">ثبت ارزیابی</button>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbxffEmwj3VRFpTPQIN2cNJVCmSkQbTnEDOI1230NVMRF7V9bJ8z4yhV7fuftPRoCEIy/exec";

// گرفتن id از URL
const urlParams = new URLSearchParams(window.location.search);
const inputId = urlParams.get("id");

let scores = {}; // ذخیره امتیازها

if (inputId) {
  // قدم اول: گرفتن EvaluateList
  fetch(`${apiUrl}?action=getEvaluateList&id=${inputId}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById("userCard").innerText = "داده معتبر یافت نشد.";
        document.getElementById("userCard").style.display = "block";
        return;
      }

      // ستون M = index 12 و ستون T = index 19
      const row = data.find(r => r[12] === inputId);
      if (!row) {
        document.getElementById("userCard").innerText = "شناسه در لیست وجود ندارد.";
        document.getElementById("userCard").style.display = "block";
        return;
      }
      if (row[19] !== "Sent") {
        document.getElementById("userCard").innerText = "این ارزیابی هنوز فعال نشده است.";
        document.getElementById("userCard").style.display = "block";
        return;
      }

      // نمایش کارت کاربر
      const userCard = document.getElementById("userCard");
      userCard.innerHTML = `
        <div class="user-info">
          <img src="${row[15]}" class="avatar">
          <div>
            <div class="name">${row[1]}</div>
            <div class="role">${row[5]}</div>
          </div>
        </div>`;
      userCard.style.display = "block";

      // قدم دوم: گرفتن PrsEvaluate
      return fetch(`${apiUrl}?action=getPrsEvaluate&id=${inputId}`);
    })
    .then(res => res ? res.json() : null)
    .then(data => {
      if (!data) return;
      const container = document.getElementById("evaluateList");
      let axes = {};
      data.forEach(row => {
        const axis = row[7]; // ستون H
        const kpi  = row[8]; // ستون I
        if (!axes[axis]) axes[axis] = [];
        axes[axis].push(kpi);
      });

      container.innerHTML = "";
      for (let axis in axes) {
        container.innerHTML += `<div class="axis">${axis}</div>`;
        axes[axis].forEach(kpi => {
          const kpiId = kpi.replace(/\s+/g,'_');
          container.innerHTML += `
            <div class="kpi">${kpi}</div>
            <div class="stars" data-kpi="${kpi}">
              ${[1,2,3,4,5].map(n => `<span data-val="${n}">★</span>`).join("")}
            </div>`;
        });
      }
      container.style.display = "block";
      document.getElementById("submitBtn").style.display = "block";

      // event handler ستاره‌ها
      document.querySelectorAll(".stars span").forEach(star => {
        star.addEventListener("click", e => {
          const val = parseInt(star.dataset.val);
          const parent = star.parentElement;
          const kpi = parent.dataset.kpi;
          scores[kpi] = val;
          parent.querySelectorAll("span").forEach(s => {
            s.classList.toggle("active", parseInt(s.dataset.val) <= val);
          });
        });
      });
    });

  // دکمه ثبت
  document.getElementById("submitBtn").addEventListener("click", () => {
    for (let kpi in scores) {
      fetch(apiUrl, {
        method: "POST",
        body: new URLSearchParams({
          action: "savePrsEvaluate",
          id: inputId,
          kpi: kpi,
          score: scores[kpi]
        })
      });
    }
    alert("امتیازها ثبت شد.");
  });
}
</script>
</body>
</html>
